<!DOCTYPE html>
<html dir="ltr" lang="ja">

<head>
  <title>a</title>
  <script src="jquery-3.7.0.min.js"></script>
  <script src="lodash.min.js"></script>
  <link rel="stylesheet" href="style.css" type="text/css">
</head>

<body>
  <div class="main">
    <div class="menu">
      <label>
        <span class="editor-label">JSON</span>
        <textarea class="editor" name="editor" value="1" id="editor"></textarea>
      </label>
    </div>
    <div class="menu">
      <label>
        <span class="editor-label">
          Preview(右クリックでコピー)
          <select id="tileset_list">
            <option>ChibiUltica</option>
            <option>MshockXotto+</option>
            <option>Cuteclysm</option>
            <option>RetroDaysTileset</option>
          </select>
        </span>
        <div class="layer-wrap">
          <canvas id="canvas" class="canvas" width="32"></canvas>
          <canvas id="overlay" class="canvas" width="32"></canvas>
        </div>
      </label>
    </div>
    <div class="menu">
      <label>
        <span class="editor-label">JSON Pallets</span>
        <textarea class="editor" name="editor_palettes" value="1" id="palettes" cols="80" rows="50"></textarea>
      </label>
    </div>
    <div class="menu">
      <label>
        <span class="editor-label">furniture(クリックでコピー)</span>
        <div id="furniture" class="palette_list"></div>
        <span class="editor-label">terrain(クリックでコピー)</span>
        <div id="terrain" class="palette_list"></div>
      </label>
    </div>
  </div>
  <script src="common.js"></script>
  <script src="tile.js"></script>
  <script src="test.js"></script>
  <script src="class_tileset.js"></script>
  <script src="class_palette.js"></script>
  <script>
    //
    // DOM
    //
    var canvas_ctx = $("#canvas")[0].getContext("2d")
    var overlay_ctx = $("#overlay")[0].getContext("2d")
    var editor = $("#editor")
    var editor_palettes = $("#palettes")
    var tileset_list = $("#tileset_list")
    var palettes_preview = $("#palettes_preview")
    editor.val(JSON.stringify(test_data, null, 2))
    editor_palettes.val(JSON.stringify(palettes_json, null, 2))
    //
    // Size
    //
    const canvas_resize = () => {
      var w = $('.canvas').outerWidth()
      var h = w * $("#canvas")[0].height / $("#canvas")[0].width
      $('.canvas').outerHeight(h * 0.9)
      $('.editor').outerHeight(h * 0.9)
      $('.menu').outerHeight(h)
    }
    const set_canvas_size = (canvas_ctx, x, y, sw, sh) => {
      canvas_ctx.canvas.width = x * sw
      canvas_ctx.canvas.height = y * sh
      overlay_ctx.canvas.width = x * sw
      overlay_ctx.canvas.height = y * sh
      canvas_resize()
    }
    $(window).on('resize',function(){
      canvas_resize()
    })

    //
    // global
    //
    const url_pre = "https://raw.githubusercontent.com/CleverRaven/Cataclysm-DDA/master/gfx/"
    var tileset = null
    var cur_palette = new Palette({})
    var palettes = {}
    var select_char = ""

    const get_id_str = (c, a = []) => {
      var f = force_array(cur_palette.get_furniture(c))[0]
      if (f != "null") {
        return f
      }
      var t = force_array(cur_palette.get_terrain(c))[0]
      if (t != "null") {
        return t
      }

      for (e of a) {
        f = force_array(palettes[e].get_furniture(c))[0]
        if (f != "null") {
          return f
        }
        t = force_array(palettes[e].get_terrain(c))[0]
        if (t != "null") {
          return t
        }
      }
      return "null"
    }

    const clip = (char) => {
      navigator.clipboard.writeText(char)
      select_char = char
    }

    const reflesh = () => {
      if(!tileset || !tileset.is_valid()){
        return
      }
      var json = JSON.parse(editor.val())[0]
      var x = 0
      var y = 0
      cur_palette = new Palette(json.object)

      var palettes_text = editor_palettes.val()
      var palettes_json = JSON.parse(palettes_text)
      palettes = {}
      palettes_json.forEach(j => {
        const tmp = new Palette(j)
        palettes[tmp.id] = tmp
      })

      var x_size = 0
      var y_size = 0
      for (const l of json.object.rows) {
        x_size = x_size > l.length ? x_size : l.length
        y_size++
      }
      set_canvas_size(canvas_ctx, x_size, y_size, tileset.width, tileset.height)


      var lines = []
      for (x = 0; x < x_size; x++) {
        var line = []
        for (y = 0; y < y_size; y++) {
          line.push(json.object.fill_ter)
        }
        lines.push(line)
      }
      canvas_ctx.clearRect(0, 0, canvas_ctx.canvas.width, canvas_ctx.canvas.height)
      tileset.draw_all(canvas_ctx, lines)

      y = 0
      var fb_lines = []
      json.object.rows.forEach((line) => {
        var array = [...line]
        x = 0
        array.forEach(c => {
          lines[y][x] = get_id_str(c, json.object.palettes)
          x++
        })
        fb_lines.push(array)
        y++
      })
      tileset.draw_all(canvas_ctx, lines, fb_lines)

      json.object.place_monster.forEach(m => {
        tileset.draw(canvas_ctx, m.monster, m.x, m.y)
      })

      var pellet_sprites = []
      var pellet_fb = []
      const targets = ["terrain", "furniture"]
      const palettes_array = json.object.palettes.map(pid => palettes[pid])
      palettes_array.unshift(cur_palette)
      for(const tgt of targets){
        $("#" + tgt).empty()
        for(const p of palettes_array){
          for(const key in p[tgt]) {
            const id = force_array(p[tgt][key])[0]
            var c = $('<canvas></canvas>')
            var ctx = c[0].getContext("2d")
            $("#" + tgt)
              .append($('<span></span>')
              .append(c
              .attr('onclick', 'clip("' + key + '")')))
            $("#" + tgt)
              .append($('<span></span>')
              .append(key))
            ctx.canvas.width = tileset.width
            ctx.canvas.height = tileset.height
            tileset.draw(ctx, id, 0, 0, key)
          }
        }
      }
    }

    const load_tileset = (id) => {
      jQuery.ajax({
        type: 'get',
        dataType:'text',
        cache: false,
        url: url_pre + tileset_list.val() + "/tile_config.json"
      }).done((data) => {
        console.log("ajax success ", tileset_list.val())
        tileset = new Tileset(JSON.parse(data), url_pre + tileset_list.val() + "/", [reflesh])
      }).fail((jqXHR, textStatus, errorThrown) => {
        console.log("Error in ajax");
        console.log("jqXHR          : " + jqXHR.status)
        console.log("textStatus     : " + textStatus)
        console.log("errorThrown    : " + errorThrown.message)
        console.log("URL            : " + url)
        tileset = new Tileset(default_tileset_json, "ChibiUltica" + "/", [reflesh])
      })
    }


    const main = () => {
      //
      // Set Event
      //
      editor.on({
        input: reflesh
      })
      editor_palettes.on({
        input: reflesh
      })
      tileset_list.on({
        change: function(){
          load_tileset(tileset_list.val())
        }
      })

      const get_mouse_point = e => {
        // https://note.affi-sapo-sv.com/js-canvas-click-coordinate.php
        const rect = e.target.getBoundingClientRect();
        const viewX = e.clientX - rect.left
        const viewY = e.clientY - rect.top
        const scaleWidth = $("#canvas")[0].clientWidth / $("#canvas")[0].width
        const scaleHeight = $("#canvas")[0].clientHeight / $("#canvas")[0].height
        const x = parseInt(Math.floor(viewX / scaleWidth) / tileset.width)
        const y = parseInt(Math.floor(viewY / scaleHeight) / tileset.height)
        return {x: x, y: y}
      }

      $("#overlay").on("click", e => {
        const p = get_mouse_point(e)
        if(select_char != ""){
          var json = JSON.parse(editor.val())
          json[0].object.rows[p.y] = json[0].object.rows[p.y].substr(0, p.x) + select_char + json[0].object.rows[p.y].substr(p.x + 1)
          editor.val(JSON.stringify(json, null, 2))
          reflesh()
        }
      })

      $("#overlay").on("contextmenu", (e) => {
        const p = get_mouse_point(e)
        var json = JSON.parse(editor.val())
        select_char = json[0].object.rows[p.y].charAt(p.x)
        reflesh()
        return false
      })
      
      $("#overlay").mouseout(() => {
        reflesh()
      })

      $("#overlay").mousemove(_.throttle(e => {
        const p = get_mouse_point(e)
        reflesh()
        overlay_ctx.rect(
          p.x * tileset.width, p.y * tileset.height,
          tileset.width, tileset.height
        )
        overlay_ctx.strokeStyle = "yellow"
        overlay_ctx.lineWidth = 1
        overlay_ctx.stroke()
        var json = JSON.parse(editor.val())
        tileset.draw(overlay_ctx, get_id_str(select_char, json[0].object.palettes), p.x, p.y, select_char)
      }, 200))
      //
      // Init
      //
      load_tileset(tileset_list.val())
    }

    main()

  </script>
</body>

</html>