<!DOCTYPE html>
<html dir="ltr" lang="ja">

<head>
  <title>a</title>
  <script src="jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="style.css" type="text/css">
</head>

<body>
  <div class="menu">
    <label>
      <span class="editor-label">JSON</span>
      <textarea class="editor" name="editor" value="1" id="editor" cols="80" rows="50"></textarea>
    </label>
    <label>
      <span class="editor-label">
        Preview
        <select id="tileset_list">
          <option>ChibiUltica</option>
          <option>MshockXotto%2B</option>
          <option>Cuteclysm</option>
          <option>RetroDaysTileset</option>
        </select>
      </span>
      <canvas id="canvas" width="32" style="width:100%;"></canvas>
    </label>
  </div>
  <div class="menu">
    <label>
      <span class="editor-label">JSON Pallets</span>
      <textarea class="editor" name="editor_palettes" value="1" id="palettes" cols="80" rows="50"></textarea>
    </label>
    <label>
      <span class="editor-label">Preview</span>
      <canvas id="canvas_palettes" width="32" style="width:100%;"></canvas>
    </label>
  </div>
  <script src="common.js"></script>
  <script src="tile.js"></script>
  <script src="test.js"></script>
  <script src="class_tileset.js"></script>
  <script src="class_palette.js"></script>
  <script>
    //
    // DOM
    //
    var canvas_ctx = $("#canvas")[0].getContext("2d")
    var canvas_palettes_ctx = $("#canvas_palettes")[0].getContext("2d")
    var editor = $("#editor")
    var editor_palettes = $("#palettes")
    var tileset_list = $("#tileset_list")
    editor.val(JSON.stringify(test_data, null, 2))
    editor_palettes.val(JSON.stringify(palettes_json, null, 2))

    //
    // global
    //
    const url_pre = "https://raw.githubusercontent.com/CleverRaven/Cataclysm-DDA/master/gfx/"
    var tileset = null
    var cur_palette = new Palette({})
    var palettes = {}

    const reflesh = () => {
      if(!tileset || !tileset.is_valid()){
        return
      }
      var text = editor.val()
      var json = JSON.parse(text)[0]
      var x = 0
      var y = 0
      cur_palette = new Palette(json.object)

      var palettes_text = editor_palettes.val()
      var palettes_json = JSON.parse(palettes_text)
      palettes = {}
      palettes_json.forEach(j => {
        const tmp = new Palette(j)
        palettes[tmp.id] = tmp
      })

      const set_canvas_size = (canvas_ctx, x, y, sw, sh) => {
        canvas_ctx.canvas.width = x * sw
        canvas_ctx.canvas.height = y * sh
      }
      var x_size = 0
      var y_size = 0
      for (const l of json.object.rows) {
        x_size = x_size > l.length ? x_size : l.length
        y_size++
      }
      set_canvas_size(canvas_ctx, x_size, y_size, tileset.width, tileset.height)

      const get_id_str = (c, a = []) => {
        var f = force_array(cur_palette.get_furniture(c))[0]
        if (f != "null") {
          return f
        }
        var t = force_array(cur_palette.get_terrain(c))[0]
        if (t != "null") {
          return t
        }

        for (e of a) {
          f = force_array(palettes[e].get_furniture(c))[0]
          if (f != "null") {
            return f
          }
          t = force_array(palettes[e].get_terrain(c))[0]
          if (t != "null") {
            return t
          }
        }
        return "null"
      }

      var lines = []
      for (x = 0; x < x_size; x++) {
        var line = []
        for (y = 0; y < y_size; y++) {
          line.push(json.object.fill_ter)
        }
        lines.push(line)
      }
      canvas_ctx.clearRect(0, 0, canvas_ctx.canvas.width, canvas_ctx.canvas.height)
      tileset.draw_all(canvas_ctx, lines)

      y = 0
      var fb_lines = []
      json.object.rows.forEach((line) => {
        var array = [...line]
        x = 0
        array.forEach(c => {
          lines[y][x] = get_id_str(c, json.object.palettes)
          x++
        })
        fb_lines.push(array)
        y++
      })
      tileset.draw_all(canvas_ctx, lines, fb_lines)

      json.object.place_monster.forEach(m => {
        tileset.draw(canvas_ctx, m.monster, m.x, m.y)
      })

      var pellet_sprites = [[], []]
      var pellet_fb = [[], []]
      for(var key in cur_palette.terrain) {
        pellet_sprites[0].push(force_array(cur_palette.terrain[key])[0])
        pellet_fb[0].push(key)
      }
      for(var key in cur_palette.furniture) {
        pellet_sprites[1].push(force_array(cur_palette.furniture[key])[0])
        pellet_fb[1].push(key)
      }
      set_canvas_size(canvas_palettes_ctx, pellet_sprites[1].length, pellet_sprites.length, tileset.width, tileset.height)
      tileset.draw_all(canvas_palettes_ctx, pellet_sprites, pellet_fb)
    }

    const load_tileset = (id) => {
      jQuery.ajax({
        type: 'get',
        dataType:'text',
        cache: false,
        url: url_pre + tileset_list.val() + "/tile_config.json"
      }).done((data) => {
        console.log("ajax success ", tileset_list.val())
        tileset = new Tileset(JSON.parse(data), url_pre + tileset_list.val() + "/", [reflesh])
      }).fail((jqXHR, textStatus, errorThrown) => {
        console.log("Error in ajax");
        console.log("jqXHR          : " + jqXHR.status)
        console.log("textStatus     : " + textStatus)
        console.log("errorThrown    : " + errorThrown.message)
        console.log("URL            : " + url)
        tileset = new Tileset(default_tileset_json, "ChibiUltica" + "/", [reflesh])
      })
    }

    const main = () => {
      //
      // Set Event
      //
      editor.on({
        input: reflesh
      })
      editor_palettes.on({
        input: reflesh
      })
      tileset_list.on({
        change: function(){
          load_tileset(tileset_list.val())
        }
      })
      //
      // Init
      //
      load_tileset(tileset_list.val())
    }

    main()

  </script>
</body>

</html>